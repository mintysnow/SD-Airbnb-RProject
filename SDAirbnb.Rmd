---
title: "SD Airbnb R Project"
output: html_notebook
---

## Introduction 
+ Breakdown of neighborhoods to districts
+ How many listings are in San Diego and where are they located?
+ Which hosts have multiple listings and where are they?
+ Average number of occupants allowed in a rental
+ As a prospective host, where should you consider opening an airbnb? 
+ As a prospective guest, where are most guest staying in San Diego and how much are they paying?
+ What impact does listing proximity to the beach have on Airbnb pricing?

## 1. Data Preprocessing

### 1.1 Load libraries
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggpubr)
library(plotly)
library(data.table)
library(wordcloud)
library(tm)
library(RColorBrewer)
```

### 1.2 Load dataset
```{r load_data, cache=TRUE, warning=FALSE, message=FALSE}
raw.df <- readr::read_csv("./listings.csv")
raw.df
sd.df = raw.df
```

### 1.3 Clean data
```{r}
sort(unique(sd.df$neighbourhood))
```

```{r}
#Creating districts - 9 districts in SD
northwestern <- c("Carmel Valley", "Del Mar Heights", "Del Mar Mesa", "Fairbanks Ranch Country Club", "La Jolla", "Beach Barber Tract","Bird Rock","Country Club","Hidden Valley","La Jolla", "La Jolla Alta","La Jolla Farms","La Jolla Heights","La Jolla Mesa","La Jolla Shores","La Jolla Village","Lower Hermosa","Muirlands","Muirlands West","Soledad South","Upper Hermosa","Village of La Jolla", "Pacific Highlands Ranch", "Torrey Hills", "Torrey Pines", "University City", "Via de la Valle", "North City")

western <-c("Bay Ho","Bay Park","Harbor Island","Liberty Station","Midway","Mission Bay", "Mission Bay Park","Mission Beach","Morena","Ocean Beach","Pacific Beach","Point Loma","Fleet Ridge","La Playa","Loma Portal","Point Loma Heights","Loma Alta","Loma Palisades","Ocean Beach Highlands","Point Loma Highlands","Roseville","Wooded Area","Shelter Island","Sunset Cliffs", "Moreno Mission", "Midtown District")

central <-c("Balboa Park","Bankers Hill","Downtown","Columbia","Core","Cortez Hill","East Village","Gaslamp Quarter","Harborview","Little Italy","Marina","Golden Hill","Hillcrest","Marston Hills","Middletown","Mission Hills", "North Hills", "Normal Heights","Cherokee Park","Adams North","Adams Park","North Park","Altadena","Burlingame","Montclair","Old Town","South Park","University Heights", "Midtown", "West University Heights", "Park West", "Horton Plaza")

southeastern <- c("Alta Vista","Bay Terraces","North Bay Terrace","South Bay Terrace","Broadway Heights","Chollas View","Emerald Hills","Encanto","Jamacha","Lincoln Park","Lomita Village","O'Farrell" ,"South Encanto","Oak Park","Paradise Hills","Redwood Village","Rolando Park","Valencia Park","Webster","Bay Terrace", "Sky Line", "Jomacha-Lomita", "Darnall")

northeastern <- c("Black Mountain Ranch","Carmel Mountain","Miramar Ranch North","Rancho Bernardo","Rancho Encantada", "Stonebridge","Rancho PeÃ±asquitos","Sabre Springs","San Pasqual Valley","Scripps Ranch","Torrey Highlands","Rancho Penasquitos", "Rancho Bernadino")

northern <- c("Clairemont","Clairemont Mesa","Clairemont Mesa East","Clairemont Mesa West","North Clairemont","Kearny Mesa","Mira Mesa","Miramar","Sorrento Valley","Sorrento Mesa")

eastern <- c("Allied Gardens","Birdland","Del Cerro","Grantville","Lake Murray","Linda Vista","Mission Valley","Mission Valley East","Civita","Mission Valley West","Hotel Circle","San Carlos","Serra Mesa","Tierrasanta", "Bird Land")

southernsouth <- c("Barrio Logan","Grant Hill","Logan Heights","Memorial","Shelltown","Sherman Heights","Stockton","San Ysidro", "Amphitheater And Water Park", "Nestor", "Bario Logan","Tijuana River Valley", "Egger Highlands", "Palm City")

midcity <- c("City Heights","Azalea Park","Castle","Cherokee Point","Chollas Creek","Colina del Sol","Corridor","Fairmount Park","Gateway","Bay Ridge","Fairmount Village","Fox Canyon","Hollywood Park","Islenair","Ridgeview","Swan Canyon","Teralta East","Teralta West","College Area","Alvarado Estates","College East","College West","El Cerrito","Kensington","Mount Hope","Mountain View","Rolando Village","Southcrest","Talmadge", "City Heights West", "El Cerritos", "City Heights East", "Rolando")
```

```{r}
sd.df = sd.df %>%
  mutate(
    district = case_when(
      neighbourhood %in% northwestern ~ "Northwestern",
      neighbourhood %in% western ~ "Western",
      neighbourhood %in% central ~ "Central",
      neighbourhood %in% southeastern ~ "Southeastern",
      neighbourhood %in% northeastern ~ "Northeastern",
      neighbourhood %in% northern ~ "Northern",
      neighbourhood %in% eastern ~ "Eastern",
      neighbourhood %in% southernsouth ~ "SouthernSouth",
      neighbourhood %in% midcity ~ "Midcity"
    ))
sd.df
```

```{r}
#finding all NA values
sum(is.na(sd.df$district))
```
```{r}
sd.df
```

```{r}
#finding neighbourhoods with NA value to verify they're not located in SD
subset(sd.df,is.na(district))
```

```{r}
#dropping rows with NA
sd.df = sd.df %>%
  drop_na(district)
```
```{r}
#verifying no NA in district column
sum(is.na(sd.df$district))
```

## Q1. Which district had the most listings

```{r}
table(sd.df$district)
```
```{r}
num_listing <- sd.df %>%
  group_by(district) %>% 
  count('district') 

num_listing
```

```{r}
dist_numl <-ggplot(num_listing, aes(x= reorder(district, desc(n)), y=n, fill=district)) +
  geom_bar(stat="identity")+theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label=n), vjust=1., color="white", position = position_dodge(0.9), size=3.5) +
  labs(x = "District", y = "Number of Listings", title = "Districts by Listings")
  
dist_numl
```

## Q2. Which district has the highest and lowest price per night
```{r}
#finding average price by district
avgPPN_dist = aggregate(x = sd.df$price,
          by = list(sd.df$district),
          FUN = mean) 
          
avgPPN_dist$x <- round(avgPPN_dist$x, digits = 2)
avgPPN_dist <- rename(avgPPN_dist, District = Group.1, Avg_Price_PN = x)
avgPPN_dist
```

```{r}
dist_ppn <-ggplot(avgPPN_dist, aes(x= reorder(District, desc(Avg_Price_PN)), y=Avg_Price_PN, fill=District)) +
  geom_bar(stat="identity")+theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label=Avg_Price_PN), vjust=1.6, color="white", position = position_dodge(0.9), size=3.5) +
  labs(x = "Districts in San Diego", y = "AVG Price / Night ($)", title = "Districts by AVG Price Per Night")
  
dist_ppn
```
## Q3. What is the most common type of place listed?
```{r}
sum_rtype = table(sd.df$room_type)
sum_rtype
```

```{r}
write.csv(sum_rtype, "C:\\Users\\yim\\Documents\\NYC Datascience Academy\\SD-Airbnb-RProject\\SD-Airbnb-RProject\\sum_rtype.csv", row.names=FALSE)
```

```{r}
#barplot(table(sd.df$room_type)) 
```

```{r}
sRoomType.df <- readr::read_csv("./sum_rtype.csv")
sRoomType.df <- rename(sRoomType.df, Room_Type = Var1, Count_of_Listings = Freq)
sRoomType.df
```


```{r}
# ggplot(sRoomType.df, aes(Room_Type, Count_of_Listings)) +
#   geom_linerange(
#     aes(x = Room_Type, ymin = 0, ymax = Count_of_Listings), 
#     color = "lightgray", size = 1.5
#     )+
#   geom_point(aes(color = Room_Type), size = 2)+
#   ggpubr::color_palette("jco")+
#   theme_pubclean()
```

```{r}
ggplot(sRoomType.df, aes(x= reorder(Room_Type, desc(Count_of_Listings)), y=Count_of_Listings, fill=Room_Type)) +
  geom_bar(stat="identity")+theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label=Count_of_Listings), vjust=0, color="black", position = position_dodge(0.9), size=3.5) +
  labs(x = "Room Type", y = "Count of Listings", title = "Room Type by Count of Listings")
```
```{r}
newhovertext=paste0(sd.df$room_type,"<br>", sd.df$price)
```

## How does room type affect price?
```{r}
g <- ggplot(sd.df, aes(x=room_type, y=price, fill=room_type, label = newhovertext)) + 
    geom_boxplot(alpha=0.3, outlier.shape = NA) +
    scale_y_continuous(limits = quantile(sd.df$price, c(0.1, 0.9))) +
    theme(legend.position="none") +
    scale_fill_brewer(palette="BuPu") +
    labs(x = "Room Type", y = "Price", title = "Room Type by Price")

g %>% ggplotly()
```
```{r}
sd.df
```

# Unable to get the desc(number_of_reviews_ltm) to work
```{r}
ggplot(sd.df, aes(x= reorder(district, desc(number_of_reviews)), y=number_of_reviews, fill=district)) +
  geom_bar(stat="identity")+theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label=number_of_reviews), vjust=1.6, color="black", position = position_dodge(0.9), size=3.5) +
  labs(x = "District", y = "Number of Reviews", title = "District by Number of Reviews")
  
```
```{r}
#exploring to see if there is any reason western had more reviews than Northeastern
```

## What are common words used in the listing of highly reviewed listings vs low review listings (100 listings)
```{r}
top10rev <- sd.df %>% 
  select(name, number_of_reviews) %>% 
  arrange(desc(number_of_reviews)) %>% 
  filter(number_of_reviews > quantile(number_of_reviews, .8))
  #top_n(100)
```
```{r}
bot10rev <- sd.df %>% 
  select(name, number_of_reviews) %>% 
  arrange(number_of_reviews) %>% 
  filter(number_of_reviews > quantile(number_of_reviews, .2))
```


```{r}
corpus <- Corpus(VectorSource(top10rev$name))

corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, stripWhitespace)


tdm <- TermDocumentMatrix(corpus)
m <- as.matrix(tdm)
v <- sort(rowSums(m), decreasing=TRUE)
d <- data.frame(word = names(v), freq=v)

wordcloud(d$word, d$freq, random.order=FALSE, rot.per=0.3, scale=c(4,.5),max.words=50, colors = brewer.pal(8,"Dark2"))
title(main="Top 10%", font.main =1, cex.main=1.5)
```
```{r}
corpus <- Corpus(VectorSource(bot10rev$name))

corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, stripWhitespace)


tdm <- TermDocumentMatrix(corpus)
m <- as.matrix(tdm)
v <- sort(rowSums(m), decreasing=TRUE)
d <- data.frame(word = names(v), freq=v)

wordcloud(d$word, d$freq, random.order=FALSE, rot.per=0.3, scale=c(4,.5),max.words=50, colors = brewer.pal(8,"Dark2"))
title(main="Bottom 10%", font.main =1, cex.main=1.5)
```
```{r}
sd.df
```

## listings of western vs northeastern
### Of the top words found in the listing for western, 5 of them were related to the water
```{r}
westernlist <- sd.df %>% 
  filter(district == "Western") %>% 
  select(name, number_of_reviews)
  #arrange(desc(number_of_reviews)) %>% 
  #filter(number_of_reviews > quantile(number_of_reviews, .8))
  #top_n(100)
```
```{r}
northeasternlist <- sd.df %>% 
  filter(district == "Northeastern") %>% 
  select(name, number_of_reviews) 
  #arrange(number_of_reviews) %>% 
  #filter(number_of_reviews > quantile(number_of_reviews, .2))
northeasternlist
```
```{r}
corpus <- Corpus(VectorSource(westernlist$name))

corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, stripWhitespace)


tdm <- TermDocumentMatrix(corpus)
m <- as.matrix(tdm)
v <- sort(rowSums(m), decreasing=TRUE)
d <- data.frame(word = names(v), freq=v)

wordcloud(d$word, d$freq, random.order=FALSE, rot.per=0.3, scale=c(4,.5),max.words=50, colors = brewer.pal(8,"Dark2"))
title(main="Western Listing", font.main =1, cex.main=1.5)
```
```{r}
corpus <- Corpus(VectorSource(northeasternlist$name))

corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, stripWhitespace)


tdm <- TermDocumentMatrix(corpus)
m <- as.matrix(tdm)
v <- sort(rowSums(m), decreasing=TRUE)
d <- data.frame(word = names(v), freq=v)

wordcloud(d$word, d$freq, random.order=FALSE, rot.per=0.3, scale=c(4,.5),max.words=50, colors = brewer.pal(8,"Dark2"))
title(main="Northeastern Listing", font.main =1, cex.main=1.5)
```

```{r}
# # Grouped barchart of district room types
# ggplot(sd.df, aes(fill=Room_Type, y=value, x=Room_Type)) + 
#     geom_bar(position="dodge", stat="identity")
```

```{r}
# ggplot(sd.df, aes(x=n
# p+geom_vline(data=mu, aes(xintercept=grp.mean, color=price),
#              linetype="dashed")
# ```ame, fill=price)) +
#   geom_density()
# # Use semi-transparent fill
# p<-ggplot(df, aes(x=name, fill=price)) +
#   geom_density(alpha=0.4)
# p
# # Add mean lines
```

```{r}

```

```{r}

```

```{r}

```

